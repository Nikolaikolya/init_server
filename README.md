# Утилита настройки сервера Ubuntu 24

Эта утилита предназначена для автоматизации начальной настройки серверов Ubuntu 24, предоставляя удобный и безопасный способ развертывания и конфигурирования вашей инфраструктуры.

## Возможности

- **Безопасность:** настройка SSH, генерация сложных паролей, настройка брандмауэра (UFW)
- **Управление пользователями:** создание пользователей с правами sudo, настройка SSH-доступа
- **Веб-сервер:** автоматическая настройка Nginx с Docker
- **SSL-сертификаты:** автоматическая настройка HTTPS с помощью Let's Encrypt и Certbot
- **Контейнеризация:** установка Docker и Docker Compose
- **CI/CD:** настройка GitLab Runners
- **Логирование:** подробное цветное логирование всех операций
- **Аудит:** отслеживание всех выполняемых действий
- **Шифрование:** защита чувствительных данных с использованием AES-GCM
- **Резервное копирование:** создание и восстановление конфигураций

## Требования

- Операционная система: Ubuntu 24.04 LTS
- Права суперпользователя (root)
- Подключение к интернету
- Rust 1.78+ (если собираете из исходников)

## Установка

### Из исходного кода

```bash
# Клонируйте репозиторий
git clone https://github.com/username/bash_script.git
cd bash_script

# Сборка проекта
cargo build --release

# Копирование исполняемого файла в каталог bin
sudo cp target/release/bash_script /usr/local/bin/init_server
sudo chmod +x /usr/local/bin/init_server
```

## Использование

### Интерактивный режим

```bash
sudo init_server
```

В интерактивном режиме утилита будет запрашивать все необходимые параметры для настройки сервера.

### Автоматический режим

```bash
sudo init_server -auto -user admin -ssh-key "ssh-rsa AAAA..." -ip-only -setup-runners
```

#### Параметры командной строки

- `-auto`: Запуск в автоматическом режиме без запросов пользователю
- `-user NAME`: Имя пользователя для создания
- `-ssh-key KEY`: SSH-ключ для добавления пользователю
- `-ip-only`: Настройка только для IP (без доменов)
- `-setup-runners`: Настройка GitLab Runners

### Удаление настроек

```bash
sudo init_server uninstall
```

Эта команда удалит все настройки, созданные утилитой.

## Структура проекта

```
src/
├── main.rs         # Точка входа, обработка аргументов командной строки
├── server.rs       # Основные функции инициализации сервера
├── config.rs       # Работа с конфигурацией, шифрование данных
├── security.rs     # Аудит, права доступа, брандмауэр
├── backup.rs       # Создание и восстановление бэкапов
├── logger.rs       # Форматирование логов, цветовой вывод
├── utils.rs        # Вспомогательные функции
├── docker.rs       # Работа с Docker и GitLab Runners
└── nginx.rs        # Настройка веб-сервера и SSL-сертификатов
```

## Модули и их функции

### main.rs
Точка входа в приложение, обрабатывает аргументы командной строки с помощью Clap.

### config.rs
- `ServerConfig` - структура для хранения конфигурации сервера
- `ServerConfig::load` - загрузка конфигурации из файла
- `ServerConfig::save` - сохранение конфигурации в файл
- `ServerConfig::encrypt_string` - шифрование строки с использованием AES-GCM
- `ServerConfig::decrypt_string` - дешифрование строки
- `ServerConfig::create_directories` - создание необходимых директорий
- `ServerConfig::generate_strong_password` - генерация надежного пароля

### logger.rs
- `init` - инициализация логгера с цветными уровнями логирования
- `command_info` - вывод информации о командах
- `success` - вывод сообщения об успешном завершении
- `password_info` - вывод информации о генерации пароля

### security.rs
- `AuditLog` - структура для хранения информации аудита
- `log_audit_event` - запись событий аудита в журнал
- `execute_command_with_audit` - выполнение команды с записью в аудит
- `configure_firewall` - настройка брандмауэра UFW
- `check_password_strength` - проверка сложности пароля
- `set_permissions` - установка прав доступа на файл/директорию

### backup.rs
- `backup_file` - создание резервной копии файла
- `restore_from_backup` - восстановление файла из резервной копии
- `clean_old_backups` - удаление старых резервных копий

### utils.rs
- `is_package_installed` - проверка установки пакета
- `install_package` - установка пакета
- `update_system` - обновление системы
- `is_root` - проверка прав суперпользователя
- `create_test_html` - создание тестового HTML-файла
- `get_server_ip` - получение IP-адреса сервера

### docker.rs
- `install_docker` - установка Docker и Docker Compose
- `create_docker_network` - создание Docker-сети
- `cleanup_containers` - очистка неиспользуемых контейнеров
- `setup_gitlab_runners` - настройка GitLab Runners

### nginx.rs
- `DomainConfig` - структура для хранения информации о домене
- `setup_nginx` - настройка Nginx с помощью Docker
- `configure_domain_proxy` - настройка прокси для домена
- `configure_domain_static` - настройка статического домена
- `generate_ssl_cert` - генерация SSL-сертификата
- `setup_certbot_renewal` - настройка автообновления сертификатов

### server.rs
- `change_root_password` - изменение пароля root
- `create_user` - создание пользователя с правами sudo
- `setup_ssh_access` - настройка SSH-доступа
- `setup_domains` - настройка доменов для Nginx
- `setup_runners` - настройка GitLab Runners
- `init_server` - инициализация сервера
- `uninstall_server` - удаление настроек сервера

## Примеры

### Настройка веб-сервера с доменом

```bash
sudo init_server -auto -user webadmin -ssh-key "$(cat ~/.ssh/id_rsa.pub)" -setup-runners
```

При интерактивном вводе доменов:
```
example.com:80  # Для проксирования на порт 80
blog.example.com:static  # Для статического содержимого
```

### Настройка сервера только с IP-адресом

```bash
sudo init_server -auto -user admin -ip-only
```

## Безопасность

- Генерируются сложные пароли (минимум 8 символов, прописные, строчные буквы и цифры)
- SSH настраивается для работы только с ключами
- Отключается доступ по паролю и root-логин через SSH
- Настраивается брандмауэр, разрешающий только необходимые порты
- Чувствительные данные шифруются с использованием AES-GCM
- Операции логируются для аудита безопасности

## Лицензия

MIT

## Авторы

Your Name <your.email@example.com> 